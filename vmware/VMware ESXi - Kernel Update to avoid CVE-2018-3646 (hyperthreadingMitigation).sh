#!/bin/sh
# ------------------------------------------------------------
#
# CVE-2018-3646 --> Enable ESXi Side-Channel-Aware Scheduler setting using ESXCLI
#

if [[ 1 -eq 1 ]]; then 
if [ $(esxcli system settings kernel list | grep -i '^hyperthreadingMitigation ' 1> '/dev/null' 2>&1; echo $?;) -eq 0 ]; then 
echo "";
echo "Enabling the ESXi Side-Channel-Aware Scheduler by setting kernel parameter 'hyperthreadingMitigation' to TRUE"; 
echo "Note:  ESXCLI states this acts to 'Restrict the simultaneous use of logical processors from the same hyperthreaded core as necessary to mitigate a security vulnerability.'";  
esxcli system settings kernel set -s hyperthreadingMitigation -v TRUE; 
echo "Getting value for parameter 'hyperthreadingMitigation' via [ esxcli system settings kernel list -o hyperthreadingMitigation; ]..."; 
esxcli system settings kernel list -o hyperthreadingMitigation; 
fi; 
if [ $(vmware -l | sed -rne 's/^([a-zA-Z\_\-\(\)\=\ ]+) ([0-9\.]+) (Update.+)$/\2/p' | grep '^6.7' | wc -l) -eq 0 ]; then 
echo ""; 
echo ""; 
echo "Versions of ESXi before 6.7-U2 can only use the SCAv1 protection scheduler (used by-default, cannot disable)"; 
else 
if [ $(esxcli system settings kernel list | grep -i '^hyperthreadingMitigationIntraVM ' 1> '/dev/null' 2>&1; echo $?;) -eq 0 ]; then 
echo ""; 
echo ""; 
echo "Enabling the ESXi Side-Channel-Aware Scheduler Version 2 (SCAv2) by setting kernel parameter 'hyperthreadingMitigationIntraVM' to FALSE"; 
echo "Note: Available starting with ESXi 6.7 U2"; 
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v FALSE; 
if [[ 0 -eq 1 ]]; then 
echo ""; 
echo ""; 
echo "Enabling the ESXi Side-Channel-Aware Scheduler (SCAv1) by setting kernel parameter 'hyperthreadingMitigationIntraVM' to TRUE"; 
echo "Note: Deprecated, use only with ESXi versions lower than 6.7 U2"; 
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v TRUE; 
fi; 
echo "Getting value for parameter 'hyperthreadingMitigationIntraVM' via [ esxcli system settings kernel list -o hyperthreadingMitigationIntraVM; ]..."; 
esxcli system settings kernel list -o hyperthreadingMitigationIntraVM; 
fi; 
fi; 
fi; 

exit;


# ------------------------------------------------------------
#
# Hotfix ESXi 6.5 (and 6.7 before U2) Systems
#
esxcli system settings kernel set -s hyperthreadingMitigation -v TRUE;


# ------------------------------------------------------------
#
# Hotfix ESXi 6.7-U2 (and-later) Systems
#
esxcli system settings kernel set -s hyperthreadingMitigation -v TRUE;
esxcli system settings kernel set -s hyperthreadingMitigationIntraVM -v FALSE; 


# ------------------------------------------------------------
#
# Citation(s)
#
#   kb.vmware.com  |  "VMware response to ‘L1 Terminal Fault - VMM’ (L1TF - VMM) Speculative-Execution vulnerability in Intel processors for vSphere: CVE-2018-3646 (55806)"  |  https://kb.vmware.com/s/article/55806
#
# ------------------------------------------------------------